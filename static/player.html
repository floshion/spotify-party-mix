<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>DJ Admin Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="favicon_flo.png">
  <style>
    body{background:#111;color:#fff;font-family:Arial,sans-serif;margin:0;padding:0;display:flex;flex-direction:column;align-items:center;min-height:100vh}
    h1{margin:20px 0}
    .main-container{display:flex;justify-content:space-between;width:95%;max-width:1200px;margin-top:30px}
    .qr-container{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center}
    #qrcode{margin-bottom:10px}
    .qr-container .logo{display:block;margin-top:20px;width:150px;height:150px;border-radius:50%;object-fit:cover;background:#111}
    .player-container{flex:2;display:flex;flex-direction:column;align-items:center;text-align:center}
    .player-container img{width:320px;height:320px;border-radius:15px;box-shadow:0 0 15px rgba(0,0,0,.8)}
    .player-container h2{font-size:28px;margin:15px 0 5px}
    .player-container p{font-size:20px;color:#ccc;margin:0}
    .progress-container{width:100%;max-width:320px;height:8px;background:#333;border-radius:4px;margin-top:15px}
    .progress-bar{height:100%;background:#1DB954;width:0%;border-radius:4px}
    .time-info{display:flex;justify-content:space-between;width:100%;max-width:320px;font-size:14px;color:#aaa;margin-top:5px}
    .controls{margin-top:20px;display:flex;gap:10px}
    .btn{background:#1DB954;color:#fff;border:none;padding:10px 20px;border-radius:5px;font-size:16px;cursor:pointer}
    .btn:hover{background:#1ed760}
    .queue-container{flex:1;background:#222;padding:15px;border-radius:10px;overflow-y:auto;max-height:500px}
    .queue-container h3{text-align:center;margin-bottom:10px}
    #priorityQueueList{list-style:none;padding:0}
    #priorityQueueList li{display:flex;align-items:center;gap:10px;background:#333;padding:8px;border-radius:5px;margin-bottom:8px}
    #priorityQueueList img{width:50px;height:50px;border-radius:5px}
  </style>
</head>
<body>
  <h1>DJ Admin Player</h1>
  <div class="main-container">
    <!-- QR code -->
    <div class="qr-container">
      <h3>Ajoutez vos morceaux</h3>
      <div id="qrcode"></div>
      <p style="color:#aaa;font-size:14px">Scannez pour participer</p>
      <img src="logo_flo_besset.png" alt="Flo BESSET" class="logo">
    </div>

    <!-- Player -->
    <div class="player-container">
      <img id="albumArt" src="" alt="Album cover">
      <h2 id="trackName">Chargement‚Ä¶</h2>
      <p id="artistName"></p>
      <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
      <div class="time-info"><span id="currentTime">0:00</span><span id="totalTime">0:00</span></div>
      <div class="controls">
        <button class="btn" id="playPauseBtn">‚èØÔ∏è Play/Pause</button>
        <button class="btn" id="nextBtn">‚è≠Ô∏è Suivant</button>
        <button class="btn" id="startBtn">‚ñ∂Ô∏è D√©marrer le lecteur</button>
        <button class="btn" id="openDisplayBtn">üì∫ Mode TV</button>
      </div>
    </div>

    <!-- File d‚Äôattente -->
    <div class="queue-container"><h3>√Ä venir :</h3><ul id="priorityQueueList"></ul></div>
  </div>

  <!-- Scripts -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    const guestUrl = window.location.origin + '/guest.html';
    new QRCode(document.getElementById('qrcode'), { text: guestUrl, width: 200, height: 200, colorDark:'#ffffff', colorLight:'#111111', correctLevel:QRCode.CorrectLevel.H });

    async function getToken(){
      const res = await fetch('/token');
      const data = await res.json();
      return data.access_token;
    }

    async function updatePriorityQueue(){
      const res  = await fetch('/priority-queue');
      const data = await res.json();
      const list = document.getElementById('priorityQueueList');
      list.innerHTML = '';
      data.queue.forEach(track=>{
        const li  = document.createElement('li');
        const img = document.createElement('img');
        img.src   = track.image;
        const span= document.createElement('span');
        span.textContent = `${track.name} ‚Äì ${track.artists}` + (track.auto?' (Auto)':'');
        li.appendChild(img); li.appendChild(span);
        list.appendChild(li);
      });
    }

    function formatTime(ms){
      const m = Math.floor(ms/60000);
      const s = Math.floor((ms%60000)/1000).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    async function updateNowPlaying() {
      const token = await getToken();
      const res = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
        headers: { Authorization: 'Bearer ' + token }
      });
      if (!res.ok) return;
      const data = await res.json();
      if (!data || !data.item) return;
      document.getElementById('albumArt').src = data.item.album.images[0].url;
      document.getElementById('trackName').textContent = data.item.name;
      document.getElementById('artistName').textContent = data.item.artists.map(a=>a.name).join(', ');
      const position = data.progress_ms;
      const duration = data.item.duration_ms;
      document.getElementById('progressBar').style.width = ((position/duration)*100)+'%';
      document.getElementById('currentTime').textContent = formatTime(position);
      document.getElementById('totalTime').textContent   = formatTime(duration);
    }

    setInterval(updateNowPlaying, 1000);
    setInterval(updatePriorityQueue, 5000);
    updateNowPlaying();
    updatePriorityQueue();

    // Activation crossfade
    async function enableCrossfade(duration = 5000) {
      const tokenRes = await fetch('/token');
      const { access_token } = await tokenRes.json();
      await fetch('https://api.spotify.com/v1/me/player', {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + access_token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          playback_settings: { crossfade_state: { duration_ms: duration } }
        })
      });
      console.log('üéöÔ∏è Crossfade activ√© :', duration/1000, 'secondes');
    }

    window.onSpotifyWebPlaybackSDKReady = () => {
      getToken().then(token => {
        const player = new Spotify.Player({
          name: 'Party DJ Player',
          getOAuthToken: cb => { cb(token); },
          volume: 0.8
        });

        // Connexion du player
        player.connect().then(success => {
          if (success) {
            enableCrossfade(5000); // Crossfade 5s
          }
        });

        // Boutons
        document.getElementById('playPauseBtn').onclick = () => player.togglePlay();
        document.getElementById('nextBtn').onclick      = async () => { await fetch('/play-priority', { method:'POST' }); updatePriorityQueue(); };
        document.getElementById('startBtn').style.display='none';

        // Mode TV
        document.getElementById('openDisplayBtn').addEventListener('click', () => {
          window.open('/display.html', '_blank');
        });
      });
    };
  </script>
</body>
</html>
