<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Télécommande DJ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- … (styles inchangés, gardés pour la brièveté) … -->
  <style>/* mêmes styles que précédemment */</style>
</head>
<body>
<header><img src="logo_flo_besset.png"><h1>Télécommande DJ</h1></header>

<div class="now">
  <img id="art" src="">
  <h2 id="title">Aucun titre</h2>
  <p id="artist"></p>
  <div class="bar"><div id="prog"></div></div>
  <div class="time"><span id="cur">0:00</span><span id="dur">0:00</span></div>
</div>

<div class="btns">
  <button class="btn" id="toggle">⏯️</button>
  <button class="btn skip" id="next">⏭️</button>
  <button class="btn add" id="open">➕ Ajouter</button>
</div>

<div class="queue"><h3>À venir</h3><div id="list"></div></div>
<div id="toast"></div>

<!-- Modal recherche -->
<div class="modal" id="searchM">
  <button class="close" id="closeM">&times;</button>
  <div class="modal-header"><input type="text" id="searchI" placeholder="Rechercher un titre…"></div>
  <div class="modal-results" id="results"></div>
</div>

<script>
/* -------- Raccourcis d’éléments -------- */
const art     = document.getElementById('art');
const title   = document.getElementById('title');
const artist  = document.getElementById('artist');
const prog    = document.getElementById('prog');
const cur     = document.getElementById('cur');
const dur     = document.getElementById('dur');
const list    = document.getElementById('list');
const toastEl = document.getElementById('toast');

const toggle  = document.getElementById('toggle');
const nextBtn = document.getElementById('next');
const openBtn = document.getElementById('open');

const searchM = document.getElementById('searchM');
const closeM  = document.getElementById('closeM');
const searchI = document.getElementById('searchI');
const results = document.getElementById('results');

/* -------- Fonctions utilitaires -------- */
function toast(msg){toastEl.textContent=msg;toastEl.style.opacity=1;setTimeout(()=>toastEl.style.opacity=0,2000);}
async function getToken(){return (await (await fetch('/token')).json()).access_token;}
function time(ms){const m=Math.floor(ms/60000),s=Math.floor((ms%60000)/1000).toString().padStart(2,'0');return m+':'+s;}

/* -------- Mise à jour Now Playing -------- */
async function now(){
  const tok=await getToken();
  const r=await fetch('https://api.spotify.com/v1/me/player/currently-playing',{headers:{Authorization:'Bearer '+tok}});
  if(r.status!==200)return;
  const d=await r.json();
  if(!d.item)return;
  art.src=d.item.album.images[0]?.url||'';
  title.textContent=d.item.name;
  artist.textContent=d.item.artists.map(a=>a.name).join(', ');
  prog.style.width=(d.progress_ms/d.item.duration_ms)*100+'%';
  cur.textContent=time(d.progress_ms);
  dur.textContent=time(d.item.duration_ms);
}

/* -------- File d’attente -------- */
async function queue(){
  const q=await (await fetch('/priority-queue')).json();
  list.innerHTML='';
  q.queue.forEach(t=>{
    list.insertAdjacentHTML('beforeend',
      `<div class="item"><img src="${t.image}"><div><strong>${t.name}</strong><span>${t.artists}</span></div></div>`);
  });
}

/* -------- Boutons télécommande -------- */
toggle.onclick = ()=> fetch('/toggle-play',{method:'POST'});
nextBtn.onclick= async ()=>{
  await fetch('/skip',{method:'POST'});
  toast('⏭️  Titre suivant');
  queue();
};

/* -------- Modal Recherche -------- */
openBtn.onclick = ()=>{
  searchM.classList.add('show');
  searchI.value='';results.innerHTML='';
  searchI.focus();
};
closeM.onclick = ()=> searchM.classList.remove('show');

searchI.oninput = async e=>{
  const q=e.target.value.trim();
  if(q.length<2){results.innerHTML='';return;}
  const tok=await getToken();
  const d=await (await fetch(
    `https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=track&limit=10`,
    {headers:{Authorization:'Bearer '+tok}})).json();
  results.innerHTML='';
  d.tracks.items.forEach(t=>{
    results.insertAdjacentHTML('beforeend',
      `<div class="result" data-uri="${t.uri}"><img src="${t.album.images[0]?.url}">
        <div><strong>${t.name}</strong><span>${t.artists.map(a=>a.name).join(', ')}</span></div></div>`);
  });
};

/* Ajout d’un morceau invité */
results.onclick = async e=>{
  const div=e.target.closest('.result');
  if(!div)return;
  await fetch('/add-priority-track?uri='+encodeURIComponent(div.dataset.uri),{method:'POST'});
  toast('Morceau ajouté');
  searchM.classList.remove('show');   // retour à l’écran télécommande
  queue();
};

/* -------- Boucles de rafraîchissement -------- */
setInterval(now,1000);
setInterval(queue,5000);
now();queue();
</script>
</body>
</html>
