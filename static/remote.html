<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Télécommande DJ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{background:#0d0d0d;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;margin:0}
    header{display:flex;align-items:center;justify-content:center;padding:12px;background:#1c1c1e;border-bottom:1px solid #333}
    header h1{font-size:20px;margin:0}
    header img{position:absolute;left:15px;width:36px;height:36px;border-radius:50%}
    .now{padding:20px;text-align:center}
    .now img{width:180px;height:180px;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.7)}
    .now h2{font-size:20px;margin:12px 0 4px}
    .now p{font-size:15px;color:#aaa;margin:0}
    .bar{width:80%;height:6px;background:#333;border-radius:3px;margin:10px auto;overflow:hidden}
    .bar div{height:100%;background:#1DB954;width:0}
    .time{display:flex;justify-content:space-between;width:80%;margin:0 auto;font-size:12px;color:#aaa}
    .btns{display:flex;justify-content:center;gap:15px;margin:20px 0}
    .btn{background:#1DB954;border:none;padding:12px 20px;border-radius:30px;font-size:16px;color:#fff}
    .btn.skip{background:#ff9800}
    .btn.add{background:#2c2c2e}
    .queue{padding:15px}
    .queue h3{margin-bottom:8px;font-size:17px}
    .item{display:flex;align-items:center;padding:6px;background:#1c1c1e;border-radius:8px;margin-bottom:6px}
    .item img{width:46px;height:46px;border-radius:6px;margin-right:10px}
    .item strong{display:block;font-size:15px}
    .item span{font-size:13px;color:#aaa}
    #toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:rgba(40,40,40,.95);
           color:#fff;padding:10px 18px;border-radius:25px;font-size:14px;opacity:0;transition:opacity .3s}
  </style>
</head>
<body>
<header><img src="logo_flo_besset.png"><h1>Télécommande DJ</h1></header>

<div class="now">
  <img id="art" src="">
  <h2 id="title">Aucun titre</h2>
  <p id="artist"></p>
  <div class="bar"><div id="prog"></div></div>
  <div class="time"><span id="cur">0:00</span><span id="dur">0:00</span></div>
</div>

<div class="btns">
  <button class="btn" id="toggle">⏯️</button>
  <button class="btn skip" id="next">⏭️</button>
  <button class="btn add" id="open">➕ Ajouter</button>
</div>

<div class="queue"><h3>À venir</h3><div id="list"></div></div>
<div id="toast"></div>

<script>
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.style.opacity=1;
setTimeout(()=>t.style.opacity=0,2000);}

async function getToken(){
  const d=await (await fetch('/token')).json();return d.access_token;
}
async function now(){
  const tok=await getToken();
  const r=await fetch('https://api.spotify.com/v1/me/player/currently-playing',
    {headers:{Authorization:'Bearer '+tok}});
  if(r.status!==200)return;
  const d=await r.json();
  if(!d.item)return;
  document.getElementById('art').src=d.item.album.images[0]?.url||'';
  document.getElementById('title').textContent=d.item.name;
  document.getElementById('artist').textContent=d.item.artists.map(a=>a.name).join(', ');
  document.getElementById('prog').style.width=(d.progress_ms/d.item.duration_ms)*100+'%';
  document.getElementById('cur').textContent=time(d.progress_ms);
  document.getElementById('dur').textContent=time(d.item.duration_ms);
}
async function queue(){
  const q=await (await fetch('/priority-queue')).json();
  const c=document.getElementById('list');c.innerHTML='';
  q.queue.forEach(t=>{
    c.insertAdjacentHTML('beforeend',
      `<div class="item"><img src="${t.image}"><div><strong>${t.name}</strong><span>${t.artists}</span></div></div>`);
  });
}

function time(ms){const m=Math.floor(ms/60000),s=Math.floor((ms%60000)/1000).toString().padStart(2,'0');return m+':'+s;}

document.getElementById('toggle').onclick=async()=>{
  await fetch('/toggle-play',{method:'POST'});
};
document.getElementById('next').onclick=async()=>{
  await fetch('/skip',{method:'POST'});
  toast('⏭️  Titre suivant');
  queue();
};
document.getElementById('open').onclick=()=>window.location.href='/guest.html';

setInterval(now,1000);setInterval(queue,5000);now();queue();
</script>
</body>
</html>
